<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Mi Boutique</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    /* --- ESTILOS GENERALES --- */
    body { font-family: 'Poppins', sans-serif; background-color: #f8f9fa; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
    
    /* Navbar */
    .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .navbar-brand { font-weight: 600; color: #333; letter-spacing: 0.5px; font-size: 1.1rem; }
    
    /* Botón Admin en Header */
    .btn-admin-header {
        cursor: pointer;
        color: #555;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 5px 10px;
        border-radius: 20px;
        transition: background 0.2s;
    }
    .btn-admin-header:hover {
        background-color: #f0f0f0;
        color: #000;
    }

    /* Tarjetas de Producto */
    .product-card { 
      border: none; border-radius: 15px; background: white; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; 
      position: relative; overflow: hidden; cursor: pointer; transition: transform 0.2s;
    }
    .product-card:active { transform: scale(0.98); }
    .card-img-top { height: 180px; object-fit: cover; width: 100%; background-color: #eee; }
    .card-body { padding: 12px 15px; }
    .card-title { font-size: 0.95rem; font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #333; }
    .price-tag { color: #2c3e50; font-weight: 700; font-size: 1.1rem; }
    
    /* Etiquetas (Nuevo / Oferta) */
    .badge-float { position: absolute; top: 10px; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; color: white; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .bg-new { left: 10px; background: #212529; }
    .bg-offer { right: 10px; background: #e74c3c; }

    /* Títulos de Sección */
    .section-header { font-weight: 600; font-size: 1rem; margin: 25px 0 15px 0; display: flex; align-items: center; text-transform: uppercase; letter-spacing: 1px; color: #555; }
    .section-header i { margin-right: 8px; }

    /* --- ADMIN PANEL --- */
    #admin-panel { 
        display: none; 
        background: #fff; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100vh; 
        z-index: 2000; 
        overflow-y: auto; 
        -webkit-overflow-scrolling: touch; 
        padding-bottom: 100px; 
    }
    .admin-header { background: #2c3e50; color: white; padding: 15px 20px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    
    /* Loaders */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
    #upload-loader { display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; flex-direction:column; justify-content:center; align-items:center; color:white; text-align: center;}
  </style>
</head>
<body>

<div id="loader">
  <div class="spinner-border text-dark" role="status"></div>
  <p class="mt-2 text-muted small" id="loading-text">Cargando catálogo...</p>
</div>

<div id="upload-loader">
    <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 class="fw-light">Subiendo foto...</h5>
    <small class="text-white-50">Espera un momento</small>
</div>

<div id="client-view">
  
  <nav class="navbar sticky-top">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      
      <span class="navbar-brand mb-0"><i class="fa-solid fa-bag-shopping me-2"></i>MI BOUTIQUE</span>
      
      <div class="btn-admin-header" onclick="abrirLogin()">
          <i class="fa-solid fa-lock me-1"></i> Admin
      </div>

    </div>
  </nav>

  <div class="container">
    
    <div id="section-new" style="display:none;">
        <div class="section-header text-dark"><i class="fa-solid fa-star text-warning"></i> Lo Nuevo</div>
        <div class="row" id="container-new"></div>
    </div>

    <div id="section-offers" style="display:none;">
        <div class="section-header text-danger"><i class="fa-solid fa-fire"></i> Ofertas Flash</div>
        <div class="row" id="container-offers"></div>
    </div>

    <div class="section-header"><i class="fa-solid fa-layer-group"></i> Colección</div>
    
    <div class="d-flex overflow-auto mb-4 pb-2" style="white-space: nowrap;">
      <button class="btn btn-dark btn-sm me-2 rounded-pill px-3" onclick="filtrar('Todo')">Todo</button>
      <button class="btn btn-outline-dark btn-sm me-2 rounded-pill px-3" onclick="filtrar('Ropa')">Ropa</button>
      <button class="btn btn-outline-dark btn-sm me-2 rounded-pill px-3" onclick="filtrar('Accesorios')">Accesorios</button>
      <button class="btn btn-outline-dark btn-sm me-2 rounded-pill px-3" onclick="filtrar('Calzado')">Calzado</button>
      <button class="btn btn-outline-dark btn-sm rounded-pill px-3" onclick="filtrar('Bolsos')">Bolsos</button>
    </div>

    <div class="row" id="container-all">
        </div>

    <div class="text-center mt-5 pt-4 border-top">
      <small class="text-muted d-block mb-2">Gracias por tu preferencia</small>
    </div>

  </div>
</div>

<div id="admin-panel">
    <div class="admin-header d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-normal"><i class="fa-solid fa-user-gear me-2"></i>Administración</h5>
        <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="salirAdmin()">Salir</button>
    </div>

    <div class="container mt-3">
        <ul class="nav nav-pills nav-fill mb-4 bg-light p-1 rounded" id="pills-tab">
            <li class="nav-item"><button class="nav-link active rounded" data-bs-toggle="pill" data-bs-target="#pills-alta">Nuevo</button></li>
            <li class="nav-item"><button class="nav-link rounded" data-bs-toggle="pill" data-bs-target="#pills-inv" onclick="cargarInventarioTabla()">Inventario</button></li>
            <li class="nav-item"><button class="nav-link rounded" data-bs-toggle="pill" data-bs-target="#pills-apart">Apartados</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pills-alta">
                <form id="formProducto" onsubmit="event.preventDefault(); procesarEnvio();">
                    
                    <div class="card border-0 shadow-sm mb-3 p-3">
                        <label class="fw-bold mb-2 text-primary">1. Foto del Producto</label>
                        <div class="d-grid gap-2">
                             <label class="btn btn-outline-secondary btn-sm text-start">
                                <i class="fa-regular fa-image me-2"></i> Subir desde Galería
                                <input type="file" id="inputFotoArchivo" accept="image/*" hidden>
                             </label>
                        </div>
                        <div class="text-center mt-2 position-relative" id="previewContainer" style="display:none;">
                            <img id="previewImg" src="" class="img-fluid rounded border" style="max-height: 200px; object-fit: contain;">
                            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 rounded-circle" onclick="limpiarFoto()" style="width: 30px; height: 30px; padding: 0;">&times;</button>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3 p-3">
                        <label class="fw-bold mb-2 text-primary">2. Detalles Principales</label>
                        <div class="form-floating mb-2">
                            <input type="text" class="form-control" id="inputNombre" placeholder="Nombre" required>
                            <label>Nombre del Producto</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="inputDesc" placeholder="Desc" style="height: 80px"></textarea>
                            <label>Descripción (Opcional)</label>
                        </div>
                        <div class="row g-2">
                            <div class="col-4">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="inputCantidad" value="1" placeholder="Cant">
                                    <label>Cant.</label>
                                </div>
                            </div>
                            <div class="col-8">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="inputColores" placeholder="Colores">
                                    <label>Colores/Tallas</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mb-3 p-3">
                         <label class="fw-bold mb-2 text-primary">3. Venta</label>
                         <div class="row g-2 mb-3">
                             <div class="col-6">
                                 <div class="form-floating">
                                    <input type="number" class="form-control fw-bold" id="inputPrecio" placeholder="$" required>
                                    <label>Precio ($)</label>
                                 </div>
                             </div>
                             <div class="col-6">
                                 <div class="form-floating">
                                     <select class="form-select" id="inputCategoria">
                                        <option value="Ropa">Ropa</option>
                                        <option value="Accesorios">Accesorios</option>
                                        <option value="Calzado">Calzado</option>
                                        <option value="Bolsos">Bolsos</option>
                                    </select>
                                    <label>Categoría</label>
                                 </div>
                             </div>
                         </div>
                         <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded mb-2">
                             <label class="form-check-label" for="checkUnico">¿Es Pieza Única?</label>
                             <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkUnico" onchange="toggleCantidad()">
                             </div>
                         </div>
                         <div class="d-flex justify-content-between align-items-center bg-light p-2 rounded">
                             <label class="form-check-label text-danger fw-bold" for="checkOferta">¡Es Oferta!</label>
                             <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkOferta">
                             </div>
                         </div>
                    </div>

                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-link text-decoration-none btn-sm text-muted" onclick="$('#detallesExtra').slideToggle()">
                            <i class="fa-solid fa-sliders me-1"></i> Costo y Ubicación (Opcional)
                        </button>
                    </div>
                    <div id="detallesExtra" style="display:none;" class="mb-4 card p-3 border-0 shadow-sm bg-light">
                        <div class="row g-2">
                            <div class="col-6"><input type="number" class="form-control form-control-sm" id="inputCosto" placeholder="$ Costo Compra"></div>
                            <div class="col-6"><input type="text" class="form-control form-control-sm" id="inputUbicacion" placeholder="Ubicación (Bodega)"></div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill shadow fw-bold mb-5">
                        <i class="fa-solid fa-cloud-arrow-up me-2"></i> GUARDAR PRODUCTO
                    </button>
                </form>
            </div>

            <div class="tab-pane fade" id="pills-inv">
                <div class="input-group mb-3 shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0" placeholder="Buscar producto..." id="buscadorInv" onkeyup="filtrarTabla()">
                </div>
                <div class="card border-0 shadow-sm overflow-hidden">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 small align-middle" id="tablaInventario">
                            <thead class="table-light"><tr><th>Prod</th><th class="text-center">Stock</th><th>Estado</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pills-apart">
                <div class="text-center mt-5 text-muted">
                    <i class="fa-solid fa-box-open fa-3x mb-3 opacity-25"></i>
                    <p>Gestión de apartados (Próximamente)</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLogin" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-sm"><div class="modal-content border-0 shadow"><div class="modal-body text-center p-4"><div class="mb-3 text-secondary"><i class="fa-solid fa-user-shield fa-2x"></i></div><h6 class="mb-3">Acceso Administrativo</h6><input type="password" id="inputPass" class="form-control text-center mb-3" placeholder="••••"><button class="btn btn-dark w-100 rounded-pill" onclick="login()">Entrar</button></div></div></div></div>

<div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <button type="button" class="btn-close position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>

      <div class="modal-body text-center p-4 position-relative">
        
        <span class="badge bg-light text-secondary border position-absolute top-0 start-0 m-3" id="modalID" style="font-size: 0.7rem;">
           Folio: --
        </span>

        <img id="modalImg" src="" class="img-fluid rounded mb-3 mt-4" style="max-height:350px; width:100%; object-fit:contain;">
        
        <h3 id="modalTitulo" class="fw-bold mb-2 text-dark"></h3>
        
        <div class="mb-3">
            <p id="modalDesc" class="text-secondary small mb-0"></p>
        </div>

        <div id="modalColores" class="mb-3"></div>
        
        <h2 id="modalPrecio" class="text-primary fw-bold mb-4 display-6"></h2>
        
        <a id="btnWhatsapp" href="#" target="_blank" class="btn btn-success w-100 rounded-pill py-3 fw-bold shadow-sm text-uppercase">
            <i class="fa-brands fa-whatsapp me-2 fa-lg"></i> Pedir por WhatsApp
        </a>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // ⚠️ TU URL DE APPS SCRIPT
  const API_URL = "https://script.google.com/macros/s/AKfycbw7LexMJGJQmz3wVSxGVJIfvr6DV0BRHz8kgLqq1Bs2Yjgrn1qm7Wz1AEX_YYMuENTlWg/exec"; 

  $(document).ready(function(){ fetchCatalog(); });

  // --- PREVIEW FOTO ---
  const inputFoto = document.getElementById('inputFotoArchivo');
  inputFoto.addEventListener('change', function() {
      if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) { $('#previewImg').attr('src', e.target.result); $('#previewContainer').fadeIn(); }
          reader.readAsDataURL(this.files[0]);
      }
  });
  function limpiarFoto() { inputFoto.value = ''; $('#previewContainer').hide(); $('#previewImg').attr('src', ''); }

  // --- GUARDAR PRODUCTO ---
  function procesarEnvio() {
      $('#upload-loader').css('display', 'flex');
      if (inputFoto.files.length > 0) {
          const reader = new FileReader();
          reader.onloadend = function() { enviarDatos(reader.result); };
          reader.readAsDataURL(inputFoto.files[0]);
      } else { enviarDatos(""); }
  }

  function enviarDatos(base64Img) {
      const payload = {
          action: "saveProduct",
          nombre: $('#inputNombre').val(),
          descripcion: $('#inputDesc').val(),
          precio: $('#inputPrecio').val(),
          categoria: $('#inputCategoria').val(),
          cantidad: $('#inputCantidad').val(),
          colores: $('#inputColores').val(),
          costo: $('#inputCosto').val(),
          ubicacion: $('#inputUbicacion').val(),
          esUnico: $('#checkUnico').is(':checked').toString(),
          esOferta: $('#checkOferta').is(':checked').toString(),
          imagen: base64Img
      };

      fetch(API_URL, { method: "POST", body: JSON.stringify(payload) })
      .then(r => r.json())
      .then(data => {
          $('#upload-loader').fadeOut();
          if(data.success) {
              alert("¡Guardado!");
              document.getElementById('formProducto').reset();
              limpiarFoto();
              $('#inputCantidad').prop('disabled', false);
              fetchCatalog();
          } else { alert("Error: " + data.message); }
      })
      .catch(e => { $('#upload-loader').fadeOut(); alert("Enviado. Verifica en unos segundos."); fetchCatalog(); });
  }

  // --- CATALOGO ---
  function fetchCatalog() {
      $('#loading-text').text("Cargando catálogo...");
      fetch(API_URL + "?action=getCatalog")
      .then(res => res.json())
      .then(data => {
          if (Array.isArray(data)) {
             renderProducts(data);
          } else {
             console.error("Error en datos:", data);
             if(data.error) alert("Error del sistema: " + data.error);
          }
          $('#loader').fadeOut();
      })
      .catch(e => { 
          console.error(e); 
          $('#loading-text').text("Error de conexión.");
          alert("Error conectando con la base de datos."); 
      });
  }

  function renderProducts(productos) {
      let htmlNew = '', htmlOffer = '', htmlAll = '';
      if(productos.length === 0) {
          $('#container-all').html('<p class="text-center text-muted w-100">No hay productos disponibles aún.</p>');
          return;
      }

      productos.forEach((p, i) => {
          let badge = '';
          if(p.oferta) badge = '<span class="badge-float bg-offer">OFERTA</span>';
          else if(i < 5) badge = '<span class="badge-float bg-new">NUEVO</span>';

          let card = `
             <div class="col-6 col-md-4 col-lg-3 item-producto mb-3" data-cat="${p.cat}">
                <div class="product-card h-100" onclick='openProduct(${JSON.stringify(p)})'>
                    ${badge}
                    <img src="${p.img && p.img.length > 10 ? p.img : 'https://via.placeholder.com/300x300?text=Sin+Foto'}" class="card-img-top">
                    <div class="card-body">
                        <div class="card-title">${p.nombre}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="price-tag">$${p.precio}</div>
                            <small class="text-muted" style="font-size:0.7rem">${p.cat}</small>
                        </div>
                    </div>
                </div>
             </div>`;
          htmlAll += card;
          if(i < 5) htmlNew += card;
          if(p.oferta) htmlOffer += card;
      });

      $('#container-all').html(htmlAll);
      if(htmlNew) { $('#container-new').html(htmlNew); $('#section-new').show(); }
      if(htmlOffer) { $('#container-offers').html(htmlOffer); $('#section-offers').show(); }
  }

  // --- ABRIR MODAL DETALLE ---
  function openProduct(p) {
      $('#modalID').text('Folio: ' + p.id);
      $('#modalImg').attr('src', p.img || 'https://via.placeholder.com/300');
      $('#modalTitulo').text(p.nombre);
      $('#modalPrecio').text('$' + p.precio);
      $('#modalDesc').text(p.desc || 'Sin descripción detallada.');

      let h = ''; 
      if(p.colores) {
          p.colores.split(',').forEach(c => h += `<span class="badge bg-light text-dark border me-1">${c}</span>`);
      }
      $('#modalColores').html(h);

      let telefono = "5218122133496"; 
      let mensaje = `Hola, me interesa este producto: *${p.nombre}* (Folio: ${p.id}). Precio: $${p.precio}. ¿Está disponible?`;
      let urlWhatsApp = `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`;
      
      $('#btnWhatsapp').attr('href', urlWhatsApp);
      $('#modalProducto').modal('show');
  }

  function filtrar(cat) { cat==='Todo' ? $('.item-producto').fadeIn() : ($('.item-producto').hide(), $('.item-producto[data-cat="'+cat+'"]').fadeIn()); }
  function toggleCantidad() { $('#checkUnico').is(':checked') ? $('#inputCantidad').val('1').prop('disabled', true) : $('#inputCantidad').prop('disabled', false); }

  // --- ADMIN ---
  function abrirLogin() { $('#modalLogin').modal('show'); }
  function salirAdmin() { $('#admin-panel').fadeOut(); $('#client-view').fadeIn(); }
  function login() {
      const pass = $('#inputPass').val();
      fetch(API_URL + "?action=login&pass=" + pass).then(r=>r.json()).then(d=>{
          if(d.authorized) { $('#modalLogin').modal('hide'); $('#client-view').hide(); $('#admin-panel').fadeIn(); $('#inputPass').val(''); }
          else { alert("Contraseña incorrecta"); $('#inputPass').val(''); }
      });
  }
  function cargarInventarioTabla() {
      $('#tablaInventario tbody').html('<tr><td colspan="3" class="text-center py-3">Cargando...</td></tr>');
      fetch(API_URL + "?action=getInventory").then(r=>r.json()).then(data => {
          if(Array.isArray(data)){
              let html = '';
              data.forEach(item => {
                  let badge = item.estado==='Activo'?'<span class="badge bg-success bg-opacity-10 text-success">Activo</span>':'<span class="badge bg-danger bg-opacity-10 text-danger">Agotado</span>';
                  html += `<tr><td><span class="fw-bold d-block text-dark">${item.nombre}</span><span class="text-muted small">${item.id}</span></td><td class="text-center fw-bold">${item.stock}</td><td>${badge}</td></tr>`;
              });
              $('#tablaInventario tbody').html(html);
          }
      });
  }
  function filtrarTabla() {
      let v = $('#buscadorInv').val().toLowerCase();
      $("#tablaInventario tbody tr").filter(function() { $(this).toggle($(this).text().toLowerCase().indexOf(v) > -1) });
  }
</script>

</body>
</html>
